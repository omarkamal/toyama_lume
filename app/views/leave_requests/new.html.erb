<% content_for :title, "New Leave Request" %>

<div class="min-h-screen bg-carbon-light">
  <!-- Header -->
  <div class="bg-white border-b border-cloudy px-4 py-4 sm:px-6">
    <div class="flex items-center gap-4">
      <%= link_to leave_requests_path, class: "inline-flex items-center gap-2 text-carbon-heavy/60 hover:text-navy transition-colors" do %>
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        <span class="text-sm font-body font-normal">Back to Leave Requests</span>
      <% end %>

      <div class="flex-1">
        <h1 class="text-xl font-heading font-medium text-navy">New Leave Request</h1>
        <p class="text-carbon-heavy/60 text-sm font-body font-light">
          Submit your time-off request for approval
        </p>
      </div>
    </div>
  </div>

  <div class="px-4 py-6">
    <div class="max-w-2xl mx-auto">
      <div class="bg-white rounded-xl border border-cloudy shadow-sm p-6">
        <%= form_with(model: @leave_request, local: true, class: "space-y-6") do |form| %>
          <%= render 'shared/errors', object: @leave_request %>

          <!-- Leave Type Selection -->
          <div class="space-y-3">
            <label class="block text-sm font-heading font-medium text-navy">Leave Type</label>
            <div class="grid grid-cols-2 gap-3">
              <div id="full-day-option" class="relative flex items-center p-4 border-2 border-teal bg-teal/5 rounded-lg cursor-pointer hover:border-teal hover:bg-teal/5 transition-all">
                <label class="flex items-center gap-3 cursor-pointer w-full">
                  <div class="w-5 h-5 rounded-full border-2 border-teal bg-teal flex items-center justify-center">
                    <div class="w-2 h-2 rounded-full bg-white"></div>
                  </div>
                  <%= form.radio_button :half_day, false, class: "sr-only", checked: true, id: "leave_request_half_day_false_fixed" %>
                  <div>
                    <div class="font-body font-medium text-navy">Full Day</div>
                    <div class="text-xs text-carbon-heavy/60">Entire day(s) off</div>
                  </div>
                </label>
              </div>

              <div id="half-day-option" class="relative flex items-center p-4 border-2 border-cloudy rounded-lg cursor-pointer hover:border-teal hover:bg-teal/5 transition-all">
                <label class="flex items-center gap-3 cursor-pointer w-full">
                  <div class="w-5 h-5 rounded-full border-2 border-cloudy flex items-center justify-center">
                    <div class="w-2 h-2 rounded-full bg-white opacity-0"></div>
                  </div>
                  <%= form.radio_button :half_day, true, class: "sr-only", id: "leave_request_half_day_true_fixed" %>
                  <div>
                    <div class="font-body font-medium text-navy">Half Day</div>
                    <div class="text-xs text-carbon-heavy/60">Half day off</div>
                  </div>
                </label>
              </div>
            </div>
          </div>

          <!-- Date Selection -->
          <div class="space-y-3">
            <label class="block text-sm font-heading font-medium text-navy">Dates</label>

            <div class="grid grid-cols-2 gap-4">
              <!-- Start Date -->
              <div>
                <%= form.label :start_date, "Start Date", class: "block text-sm font-body font-normal text-carbon-heavy mb-2" %>
                <%= form.date_field :start_date,
                    class: "w-full px-3 py-2 border border-cloudy rounded-lg focus:ring-2 focus:ring-teal focus:border-transparent font-body font-normal text-navy",
                    min: Date.current - 7.days,
                    max: Date.current + 1.year,
                    required: true %>
              </div>

              <!-- End Date -->
              <div id="end-date-field">
                <%= form.label :end_date, "End Date", class: "block text-sm font-body font-normal text-carbon-heavy mb-2" %>
                <%= form.date_field :end_date,
                    class: "w-full px-3 py-2 border border-cloudy rounded-lg focus:ring-2 focus:ring-teal focus:border-transparent font-body font-normal text-navy",
                    min: Date.current - 7.days,
                    max: Date.current + 1.year,
                    required: true %>
              </div>
            </div>
          </div>

          <!-- Duration Preview -->
          <div id="duration-preview" class="p-4 bg-carbon-light rounded-lg">
            <div class="flex items-center gap-3">
              <svg class="w-5 h-5 text-teal" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <div class="text-sm">
                <span class="font-body font-medium text-navy">Duration: </span>
                <span id="duration-text" class="text-carbon-heavy">Select dates to see duration</span>
              </div>
            </div>
            <div id="holidays-info" class="mt-2 text-xs text-carbon-heavy/50 hidden">
              <!-- Holiday information will be shown here -->
            </div>
          </div>

          <!-- Reason (Optional) -->
          <div class="space-y-3">
            <%= form.label :reason, "Reason (Optional)", class: "block text-sm font-heading font-medium text-navy" %>
            <%= form.text_area :reason,
                rows: 3,
                placeholder: "Optional: Provide any additional context for your leave request...",
                class: "w-full px-3 py-2 border border-cloudy rounded-lg focus:ring-2 focus:ring-teal focus:border-transparent font-body font-normal text-navy resize-none" %>
            <p class="text-xs text-carbon-heavy/50">
              Adding a reason helps your manager understand your request better.
            </p>
          </div>

          <!-- Form Actions -->
          <div class="flex items-center gap-4 pt-4">
            <%= link_to leave_requests_path, class: "flex-1 text-center px-4 py-2 border border-cloudy text-navy rounded-lg font-body font-normal hover:bg-carbon-light transition-colors" do %>
              Cancel
            <% end %>

            <%= form.submit "Submit Request",
                class: "flex-1 bg-lime text-navy px-4 py-2 rounded-lg font-body font-medium hover:bg-lime/90 transition-colors" %>
          </div>
        <% end %>
      </div>

      <!-- Leave Guidelines -->
      <div class="mt-6 bg-white rounded-xl border border-cloudy shadow-sm p-6">
        <div class="flex items-start gap-3">
          <svg class="w-5 h-5 text-teal mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <div>
            <h3 class="text-sm font-heading font-medium text-navy mb-2">Leave Guidelines</h3>
            <ul class="text-sm text-carbon-heavy/70 space-y-1">
              <li>â€¢ Submit requests at least 2 days in advance when possible</li>
              <li>â€¢ Maximum 30 days per single leave request</li>
              <li>â€¢ Cannot overlap with existing approved leave</li>
              <li>â€¢ Business days are calculated (weekends excluded)</li>
              <li>â€¢ Requests are subject to manager approval</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const halfDayRadio = document.getElementById('leave_request_half_day_true_fixed');
  const fullDayRadio = document.getElementById('leave_request_half_day_false_fixed');
  const fullDayOption = document.getElementById('full-day-option');
  const halfDayOption = document.getElementById('half-day-option');
  const endDateField = document.getElementById('end-date-field');
  const startDateInput = document.getElementById('leave_request_start_date');
  const endDateInput = document.getElementById('leave_request_end_date');
  const durationText = document.getElementById('duration-text');
  const holidaysInfo = document.getElementById('holidays-info');

  // Holiday data (this would ideally come from the server)
  const holidays = <%= raw @leave_request.send(:load_holidays).map { |h| h.strftime("%Y-%m-%d") }.to_json %>;

  function updateRadioStyles() {
    if (halfDayRadio.checked) {
      // Select half day
      halfDayOption.classList.add('border-teal', 'bg-teal/5');
      halfDayOption.classList.remove('border-cloudy');
      fullDayOption.classList.add('border-cloudy');
      fullDayOption.classList.remove('border-teal', 'bg-teal/5');

      // Update radio button visuals
      const halfDayIndicator = halfDayOption.querySelector('.rounded-full');
      const fullDayIndicator = fullDayOption.querySelector('.rounded-full');

      halfDayIndicator.classList.add('border-teal', 'bg-teal');
      halfDayIndicator.classList.remove('border-cloudy');
      halfDayIndicator.querySelector('.rounded-full').classList.remove('opacity-0');

      fullDayIndicator.classList.add('border-cloudy');
      fullDayIndicator.classList.remove('border-teal', 'bg-teal');
      fullDayIndicator.querySelector('.rounded-full').classList.add('opacity-0');
    } else {
      // Select full day
      fullDayOption.classList.add('border-teal', 'bg-teal/5');
      fullDayOption.classList.remove('border-cloudy');
      halfDayOption.classList.add('border-cloudy');
      halfDayOption.classList.remove('border-teal', 'bg-teal/5');

      // Update radio button visuals
      const fullDayIndicator = fullDayOption.querySelector('.rounded-full');
      const halfDayIndicator = halfDayOption.querySelector('.rounded-full');

      fullDayIndicator.classList.add('border-teal', 'bg-teal');
      fullDayIndicator.classList.remove('border-cloudy');
      fullDayIndicator.querySelector('.rounded-full').classList.remove('opacity-0');

      halfDayIndicator.classList.add('border-cloudy');
      halfDayIndicator.classList.remove('border-teal', 'bg-teal');
      halfDayIndicator.querySelector('.rounded-full').classList.add('opacity-0');
    }
  }

  function updateDuration() {
    const startDate = new Date(startDateInput.value);
    const endDate = new Date(endDateInput.value);
    const isHalfDay = halfDayRadio.checked;

    if (startDateInput.value && (isHalfDay || endDateInput.value)) {
      if (isHalfDay) {
        durationText.textContent = '0.5 day';
        holidaysInfo.classList.add('hidden');
      } else if (startDate && endDate && startDate <= endDate) {
        const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;

        // Calculate business days and check for holidays
        let businessDays = 0;
        let holidaysDuringLeave = [];
        let weekendsDuringLeave = [];
        const currentDate = new Date(startDate);

        while (currentDate <= endDate) {
          const dayOfWeek = currentDate.getDay();
          const dateString = currentDate.toISOString().split('T')[0];

          if (dayOfWeek === 0 || dayOfWeek === 6) { // Weekend
            weekendsDuringLeave.push(new Date(currentDate));
          } else if (holidays.includes(dateString)) { // Holiday
            holidaysDuringLeave.push(new Date(currentDate));
          } else { // Business day
            businessDays++;
          }
          currentDate.setDate(currentDate.getDate() + 1);
        }

        // Update duration text
        if (days === 1) {
          durationText.textContent = '1 day (1 business day)';
        } else {
          durationText.textContent = `${days} days (${businessDays} business days)`;
        }

        // Show holiday information
        if (holidaysDuringLeave.length > 0 || weekendsDuringLeave.length > 0) {
          holidaysInfo.classList.remove('hidden');
          let info = '';

          if (holidaysDuringLeave.length > 0) {
            info += `ðŸŽ‰ ${holidaysDuringLeave.length} holiday${holidaysDuringLeave.length === 1 ? '' : 's'} during this period`;
          }

          if (weekendsDuringLeave.length > 0) {
            if (info) info += ' â€¢ ';
            info += `ðŸ“… ${weekendsDuringLeave.length} weekend day${weekendsDuringLeave.length === 1 ? '' : 's'} automatically excluded`;
          }

          holidaysInfo.innerHTML = `<em>${info}</em>`;
        } else {
          holidaysInfo.classList.add('hidden');
        }
      } else {
        durationText.textContent = 'Select valid dates';
        holidaysInfo.classList.add('hidden');
      }
    } else {
      durationText.textContent = 'Select dates to see duration';
      holidaysInfo.classList.add('hidden');
    }
  }

  function toggleEndDateField() {
    if (halfDayRadio.checked) {
      endDateField.style.display = 'none';
      // Set end date to start date for half day
      if (startDateInput.value) {
        endDateInput.value = startDateInput.value;
      }
    } else {
      endDateField.style.display = 'block';
    }
    updateDuration();
  }

  // Event listeners
  halfDayRadio.addEventListener('change', function() {
    updateRadioStyles();
    toggleEndDateField();
  });

  fullDayRadio.addEventListener('change', function() {
    updateRadioStyles();
    toggleEndDateField();
  });

  // Click handlers for the entire option areas
  fullDayOption.addEventListener('click', function() {
    fullDayRadio.checked = true;
    updateRadioStyles();
    toggleEndDateField();
  });

  halfDayOption.addEventListener('click', function() {
    halfDayRadio.checked = true;
    updateRadioStyles();
    toggleEndDateField();
  });

  startDateInput.addEventListener('change', function() {
    if (halfDayRadio.checked) {
      endDateInput.value = startDateInput.value;
    }
    if (endDateInput.value && new Date(startDateInput.value) > new Date(endDateInput.value)) {
      endDateInput.value = startDateInput.value;
    }
    updateDuration();
  });
  endDateInput.addEventListener('change', updateDuration);

  // Initialize
  updateRadioStyles();
  toggleEndDateField();
});
</script>